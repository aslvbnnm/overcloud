- block:
  - become: true
    name: Get cinder_volume image from pacemaker
    register: xmllint_pcmk_cinder_volume_image
    shell: xmllint --xpath "string(//bundle[@id='openstack-cinder-volume']/podman/@image)"
      /var/lib/pacemaker/cib/cib.xml
  - name: Get container cinder_volume image
    set_fact:
      cinder_volume_image: registry.redhat.io/rhosp-rhel9/openstack-cinder-volume:17.1.6
      cinder_volume_image_latest: cluster.common.tag/cinder-volume:pcmklatest
      pcmk_cinder_volume_image: '{{xmllint_pcmk_cinder_volume_image.stdout}}'
  when: step|int in [0,2]
- block:
  - become: true
    name: Get haproxy image from pacemaker
    register: xmllint_pcmk_haproxy_image
    shell: xmllint --xpath "string(//bundle[@id='haproxy-bundle']/podman/@image)"
      /var/lib/pacemaker/cib/cib.xml
  - name: Get container haproxy image
    set_fact:
      haproxy_image: registry.redhat.io/rhosp-rhel9/openstack-haproxy:17.1.6
      haproxy_image_latest: cluster.common.tag/haproxy:pcmklatest
      pcmk_haproxy_image: '{{xmllint_pcmk_haproxy_image.stdout}}'
  when: step|int in [0,2]
- block:
  - name: set is_haproxy_bootstrap_node fact
    set_fact: is_haproxy_bootstrap_node={{haproxy_short_bootstrap_node_name|lower
      == ansible_facts['hostname']|lower}}
    tags: common
    when:
    - haproxy_short_bootstrap_node_name|default(false)
  name: Set HAProxy upgrade facts
- block:
  - become: true
    name: Get galera image from pacemaker
    register: xmllint_pcmk_galera_image
    shell: xmllint --xpath "string(//bundle[@id='galera-bundle']/podman/@image)" /var/lib/pacemaker/cib/cib.xml
  - name: Get container galera image
    set_fact:
      galera_image: registry.redhat.io/rhosp-rhel9/openstack-mariadb:17.1.6
      galera_image_latest: cluster.common.tag/mariadb:pcmklatest
      pcmk_galera_image: '{{xmllint_pcmk_galera_image.stdout}}'
  when: step|int in [0,2]
- block:
  - include_role:
      name: tripleo_ovn_cluster
    name: Configure OVN DBs and northd
    vars:
      tripleo_ovn_cluster_dbs_protocol: '{{ enable_internal_tls | ternary(''ssl'',
        ''tcp'', ''tcp'') }}'
      tripleo_ovn_cluster_nb_db_port: 6641
      tripleo_ovn_cluster_nb_local_port: 6643
      tripleo_ovn_cluster_nb_remote_port: 6643
      tripleo_ovn_cluster_nb_ssl_ca_cert: /etc/ipa/ca.crt
      tripleo_ovn_cluster_network: internal_api
      tripleo_ovn_cluster_northd_ssl_ca_cert: /etc/ipa/ca.crt
      tripleo_ovn_cluster_sb_db_port: 6642
      tripleo_ovn_cluster_sb_local_port: 6644
      tripleo_ovn_cluster_sb_remote_port: 6644
      tripleo_ovn_cluster_sb_ssl_ca_cert: /etc/ipa/ca.crt
  name: Configure OVN cluster during update
  when: step|int == 4
- block:
  - include_role:
      name: tripleo_container_manage
    loop:
    - ovn_cluster_north_db_server
    - ovn_cluster_south_db_server
    - ovn_cluster_northd
    loop_control:
      loop_var: ovn_container
    name: Start OVN container
    vars:
      tripleo_container_manage_config: /var/lib/tripleo-config/container-startup-config/step_0
      tripleo_container_manage_config_id: '{{ ovn_container }}'
      tripleo_container_manage_config_patterns: '{{ ovn_container }}.json'
  name: Update OVN cluster containers
  when: step|int == 4
- name: Start pacemaker cluster
  pacemaker_cluster: state=online
  when: step|int == 4
- command: systemd-cat -t ha-shutdown /var/lib/container-config-scripts/pacemaker_mutex_shutdown.sh
    --release
  name: Release the cluster shutdown lock
  when: step|int == 4
- block:
  - become: true
    name: Get rabbitmq image from pacemaker
    register: xmllint_pcmk_rabbitmq_image
    shell: xmllint --xpath "string(//bundle[@id='rabbitmq-bundle']/podman/@image)"
      /var/lib/pacemaker/cib/cib.xml
  - name: Get container rabbitmq image
    set_fact:
      pcmk_rabbitmq_image: '{{xmllint_pcmk_rabbitmq_image.stdout}}'
      rabbitmq_image: registry.redhat.io/rhosp-rhel9/openstack-rabbitmq:17.1.6
      rabbitmq_image_latest: cluster.common.tag/rabbitmq:pcmklatest
  when: step|int in [0,2]
- name: Check swift containers log folder/symlink exists
  register: swift_log_link
  stat:
    path: /var/log/containers/swift
- file:
    path: /var/log/containers/swift
    state: absent
  name: Delete if symlink
  when: swift_log_link.stat.islnk is defined and swift_log_link.stat.islnk
