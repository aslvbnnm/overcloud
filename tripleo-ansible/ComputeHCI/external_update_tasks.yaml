- async: 600
  become: true
  containers.podman.podman_image:
    force: true
    name: registry.redhat.io/rhosp-rhel9/openstack-ovn-controller:17.1.6
    validate_certs: false
  delegate_to: '{{ item }}'
  loop: '{{ groups[''ovn_controller''] | difference(groups[''excluded_overcloud''])
    }}'
  name: Force pull image in case image name doesn't change.
  poll: 0
  register: ovn_controller_image_update
  tags:
  - ovn
  - ovn_image
  when: step|int == 1
- async_status:
    jid: '{{ async_result_item.ansible_job_id }}'
  become: true
  delay: 1
  delegate_to: '{{ async_result_item.item }}'
  loop: '{{ovn_controller_image_update.results }}'
  loop_control:
    loop_var: async_result_item
  name: Was the ovn_controller image pull successful.
  register: async_poll_results
  retries: 600
  tags:
  - ovn
  - ovn_image
  until: async_poll_results.finished
  when:
  - step|int == 1
  - '''results'' in ovn_controller_image_update'
- debug:
    msg: ovn container will be using {{ image }}
  name: OVN Container image used
  tags: ovn
  vars:
    image: registry.redhat.io/rhosp-rhel9/openstack-ovn-controller:17.1.6
  when: step|int == 1
- async: 600
  become: true
  delegate_to: '{{ item }}'
  loop: '{{ groups[''ovn_controller''] | difference(groups[''excluded_overcloud''])
    }}'
  name: Update OVN OVS related parameters before update.
  poll: 0
  register: ovs_vsctl
  shell: 'set -e

    ovs-vsctl set Open_vSwitch . external_ids:ovn-ofctrl-wait-before-clear={{ timeout
    }}

    ovs-vsctl set Open_vSwitch . external_ids:ovn-monitor-all=true

    ovs-vsctl set Open_vSwitch . external_ids:ovn-match-northd-version=false

    '
  tags:
  - ovn
  vars:
    timeout: 8000
  when:
  - step|int == 1
- async_status:
    jid: '{{ async_result_item.ansible_job_id }}'
  become: true
  delay: 1
  delegate_to: '{{ async_result_item.item }}'
  loop: '{{ovs_vsctl.results }}'
  loop_control:
    loop_var: async_result_item
  name: Was the update of OVN OVS related parameter successful.
  register: async_poll_results
  retries: 600
  tags:
  - ovn
  until: async_poll_results.finished
  when:
  - step|int == 1
  - '''results'' in ovs_vsctl'
- set_fact:
    any_ovn_host: '{{groups[''ovn_controller''] | difference(groups[''excluded_overcloud''])
      | first }}'
  tags: ovn
  when: step|int == 1
- become: true
  delegate_to: '{{ any_ovn_host }}'
  find:
    paths: /var/lib/tripleo-config/container-startup-config/
    patterns: '*ovn_controller.json'
    recurse: true
  name: Find ovn_controller configs in container-startup-configs
  register: ovn_cont_17_0
  tags:
  - ovn
  when: (step|int == 1) and (any_ovn_host is defined) and (any_ovn_host|length > 0)
- name: get directory path from the ovn_cont_17_0
  set_fact:
    ovn_config_path: '{{ ovn_cont_17_0.files.0.path | dirname }}'
  tags: ovn
  when: step|int == 1
- async: 600
  become: true
  delegate_to: '{{ item }}'
  loop: '{{ groups[''ovn_controller''] | difference(groups[''excluded_overcloud''])
    }}'
  name: Update ovn_controller.
  poll: 0
  register: ovn_controller_update
  tags: ovn
  tripleo_container_manage:
    config_dir: '{{ ovn_config_path }}'
    config_id:
    - tripleo_step{{config_step}}
    config_overrides:
      .*ovn_controller:
        image: registry.redhat.io/rhosp-rhel9/openstack-ovn-controller:17.1.6
        name: ovn_controller
    config_patterns: '*ovn_controller.json'
    debug: '{{ enable_debug | bool }}'
    log_base_path: '{{ container_log_stdout_path }}'
  vars:
    config_step: '{{ (''step_4'' in ovn_config_path) | ternary(''4'', ''3'')}}'
  when: step|int == 1
- async_status:
    jid: '{{ async_result_item.ansible_job_id }}'
  become: true
  delay: 1
  delegate_to: '{{ async_result_item.item }}'
  loop: '{{ovn_controller_update.results }}'
  loop_control:
    loop_var: async_result_item
  name: Was the ovn_controller successful.
  register: async_poll_results
  retries: 600
  tags: ovn
  until: async_poll_results.finished
  when:
  - step|int == 1
  - '''results'' in ovn_controller_update'
