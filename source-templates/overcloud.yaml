# primary role is: Controller
heat_template_version: wallaby

description: >
  Deploy an OpenStack environment, consisting of several node types (roles),
  Controller, Compute, BlockStorage, SwiftStorage and CephStorage. The Storage
  roles enable independent scaling of the storage components, but the minimal
  deployment is one Controller and one Compute node.


# TODO(shadower): we should probably use the parameter groups to put
# some order in here.
parameters:

  # Common parameters (not specific to
  # Special case the Internal API hostname param, which is CloudNameInternal
  CloudNameInternal:
    default: overcloud.internalapi.localdomain
    description: >
      The DNS name of this cloud's internal_api endpoint. E.g.
      'ci-overcloud.internalapi.tripleo.org'.
    type: string
  InternalApiVirtualFixedIPs:
    default: []
    description: >
        Control the IP allocation for the InternalApiVirtualInterface port. E.g.
        [{'ip_address':'1.2.3.4'}]
    type: json
  CloudNameStorage:
    default: overcloud.storage.localdomain
    description: >
      The DNS name of this cloud's storage endpoint. E.g.
      'ci-overcloud.storage.tripleo.org'.
    type: string
  StorageVirtualFixedIPs:
    default: []
    description: >
        Control the IP allocation for the StorageVirtualInterface port. E.g.
        [{'ip_address':'1.2.3.4'}]
    type: json
  # Special case StorageMgmt hostname param, which is CloudNameStorageManagement
  CloudNameStorageManagement:
    default: overcloud.storagemgmt.localdomain
    description: >
      The DNS name of this cloud's storage_mgmt endpoint. E.g.
      'ci-overcloud.storagemgmt.tripleo.org'.
    type: string
  StorageMgmtVirtualFixedIPs:
    default: []
    description: >
        Control the IP allocation for the StorageMgmtVirtualInterface port. E.g.
        [{'ip_address':'1.2.3.4'}]
    type: json
  CloudNameCtlplane:
    default: overcloud.ctlplane.localdomain
    description: >
      The DNS name of this cloud's provisioning network endpoint. E.g.
      'ci-overcloud.ctlplane.tripleo.org'.
    type: string
  ExtraHostFileEntries:
    default: []
    description: List of extra hosts entries to be appended to /etc/hosts
    type: comma_delimited_list
  UndercloudHostsEntries:
    default: []
    description: >
      List of undercloud hosts entries to be appended to /etc/hosts. The
      value is populated with the HEAT_HOSTS entries on the undercloud by
      tripleoclient when running deploy.
    type: comma_delimited_list
  EndpointMapOverride:
    default: {}
    description: Can be used to override the calcluated EndpointMap
    type: json
  ExtraConfig:
    default: {}
    description: |
      Additional hiera configuration to inject into the cluster.
    type: json
  DeployedServerPortMap:
    default: {}
    type: json
  NeutronControlPlaneID:
    default: 'ctlplane'
    type: string
    description: Neutron ID or name for ctlplane network.
  NeutronPhysicalBridge:
    default: 'br-ex'
    description: An OVS bridge to create for accessing external networks.
    type: string
  NeutronPublicInterface:
    default: nic1
    description: Which interface to add to the NeutronPhysicalBridge.
    type: string
  ControlPlaneSubnet:
    description: The name of the undercloud Neutron control plane subnet
    default: ctlplane-subnet
    type: string
  ControlPlaneSubnetCidr:
    default: ''
    description: >
      The subnet CIDR of the control plane network. (The parameter is
      automatically resolved from the ctlplane subnet's cidr attribute.)
    type: string
  DnsSearchDomains: # Override this via parameter_defaults
    default: []
    description: A list of DNS search domains to be added (in order) to resolv.conf.
    type: comma_delimited_list
  ControlFixedIPs:
    default: []
    description: >
        Control the IP allocation for the ControlVirtualIP port. E.g.
        [{'ip_address':'1.2.3.4'}]
    type: json
  RabbitCookieSalt:
    type: string
    default: unset
    description: Salt for the rabbit cookie, change this to force the randomly generated rabbit cookie to change.
  CloudDomain:
    default: 'localdomain'
    type: string
    description: >
      The DNS domain used for the hosts. This must match the
      overcloud_domain_name configured on the undercloud.
  ServerMetadata:
    default: {}
    description: >
      Extra properties or metadata passed to Nova for the created nodes in
      the overcloud. It's accessible via the Nova metadata API.
    type: json
# Compute-specific params
# FIXME(shardy) handle these deprecated names as they don't match compute.yaml
  HypervisorNeutronPhysicalBridge:
    default: 'br-ex'
    description: >
      An OVS bridge to create on each hypervisor. This defaults to br-ex the
      same as the control plane nodes, as we have a uniform configuration of
      the openvswitch agent. Typically should not need to be changed.
    type: string
  HypervisorNeutronPublicInterface:
    default: nic1
    description: What interface to add to the HypervisorNeutronPhysicalBridge.
    type: string

  NodeCreateBatchSize:
    default: 30
    description: Maxiumum batch size for creating nodes
    type: number

  NovaAdditionalCell:
    default: false
    description: Whether this is an cell additional to the default cell.
    type: boolean

  NovaLocalMetadataPerCell:
    default: false
    description: >
      Indicates that the nova-metadata API service has been deployed
      per-cell, so that we can have better performance and data isolation in a
      multi-cell deployment. Users should consider the use of this configuration
      depending on how neutron is setup. If networks span cells, you might need
      to run nova-metadata API service globally. If your networks are segmented
      along cell boundaries, then you can run nova-metadata API service per cell.
      When running nova-metadata API service per cell, you should also configure
      each Neutron metadata-agent to point to the corresponding nova-metadata API
      service.
    type: boolean

  BondInterfaceOvsOptions:
    default: ''
    description: The ovs_options or bonding_options string for the bond
      interface. Set things like lacp=active and/or bond_mode=balance-slb
      for OVS bonds or like mode=4 for Linux bonds using this option.
    type: string
    constraints:
    - allowed_pattern: ^((?!balance.tcp).)*$
      description: The balance-tcp bond mode is known to cause packet loss and
        should not be used in BondInterfaceOvsOptions.

  NetworkConfigWithAnsible:
    description: NetworkConfig with ansible flag
    type: boolean
    default: True

  # Jinja loop for Role in role_data.yaml


  ControllerLocalMtu: # Override this via parameter_defaults
    default: 1500
    description: MTU to use for the Undercloud local_interface.
    type: number
    constraints:
      - range: { min: 1000, max: 65536 }
  ControllerNetworkConfigTemplate:
    description: Controller NetworkConfig Template
    type: string
    default: ''
  ControllerExtraConfig:
    default: {}
    description: |
      Role specific additional hiera configuration to inject into the cluster.
    type: json
  controllerExtraConfig:
    default: {}
    description: |
      DEPRECATED use ControllerExtraConfig instead
    type: json
  # Parameters generated for Controller Role
  ControllerServices:
    description: A list of service resources (configured in the Heat
                 resource_registry) which represent nested stacks
                 for each service that should get installed on the Controller role.
    type: comma_delimited_list
  ControllerNetworkConfigUpdate:
    type: boolean
    description: >
      When set to "True", existing networks will be updated on the overcloud.
      This parameter replaces the functionality previously provided by
      NetworkDeploymentActions. Defaults to "False" so that only new nodes will
      have their networks configured. This is a role based parameter.
    default: False
  ControllerAnyErrorsFatal:
    default: yes
    type: string
  ControllerMaxFailPercentage:
    default: 0
    type: number
  ControllerCount:
    description: Number of Controller nodes to deploy
    type: number
    default: 1

  ControllerHostnameFormat:
    type: string
    description: >
      Format for Controller node hostnames
      Note %index% is translated into the index of the node, e.g 0/1/2 etc
      and %stackname% is replaced with the stack name e.g overcloud
  
    default: "%stackname%-controller-%index%"
  
  ControllerRemovalPolicies:
    default: []
    type: json
    description: >
      List of resources to be removed from Controller ResourceGroup when
      doing an update which requires removal of specific resources.
      Example format ComputeRemovalPolicies: [{'resource_list': ['0']}]

  ControllerRemovalPoliciesMode:
    default: append
    type: string
    description: >
      How to handle change to RemovalPolicies for Controller
      ResourceGroup when doing an update. Default mode 'append' will
      append to the existing blacklist and 'update' would replace
      the blacklist.

  ControllerSchedulerHints:
    type: json
    description: Optional scheduler hints to pass to nova
    default: {}

  ControllerParameters:
    type: json
    description: Optional Role Specific parameters to be provided to service
    default: {}

  ControllerExtraGroupVars:
    type: json
    description: Optional extra Ansible group vars
    default: {}

  ControllerControlPlaneSubnet:
    default: ctlplane-subnet
    description: |
      Name of the subnet on ctlplane network for this role.
    type: string

  ControllerServiceNetMap:
    default: {}
    description: |
      Role specific ServiceNetMap overrides, the map provided will be merged
      with the global ServiceNetMap when passing the ServiceNetMap to the
      ControllerServiceChain resource and the Controller resource group.
      For example:
      ControllerServiceNetMap:
        NovaLibvirtNetwork: internal_api_leaf2
    type: json

  ControllerNetConfigOverride:
    default: {}
    description: |
      Custom JSON data to be used to override the os-net-config config.
      This is meant to be used by net_config_override parameter in tripleoclient
      to provide an easy means to pass in custom net configs for the Undercloud.
    type: json



  ComputeHCILocalMtu: # Override this via parameter_defaults
    default: 1500
    description: MTU to use for the Undercloud local_interface.
    type: number
    constraints:
      - range: { min: 1000, max: 65536 }
  ComputeHCINetworkConfigTemplate:
    description: ComputeHCI NetworkConfig Template
    type: string
    default: ''
  ComputeHCIExtraConfig:
    default: {}
    description: |
      Role specific additional hiera configuration to inject into the cluster.
    type: json
  # Parameters generated for ComputeHCI Role
  ComputeHCIServices:
    description: A list of service resources (configured in the Heat
                 resource_registry) which represent nested stacks
                 for each service that should get installed on the ComputeHCI role.
    type: comma_delimited_list
  ComputeHCINetworkConfigUpdate:
    type: boolean
    description: >
      When set to "True", existing networks will be updated on the overcloud.
      This parameter replaces the functionality previously provided by
      NetworkDeploymentActions. Defaults to "False" so that only new nodes will
      have their networks configured. This is a role based parameter.
    default: False
  ComputeHCIAnyErrorsFatal:
    default: yes
    type: string
  ComputeHCIMaxFailPercentage:
    default: 0
    type: number
  ComputeHCICount:
    description: Number of ComputeHCI nodes to deploy
    type: number
    default: 0

  ComputeHCIHostnameFormat:
    type: string
    description: >
      Format for ComputeHCI node hostnames
      Note %index% is translated into the index of the node, e.g 0/1/2 etc
      and %stackname% is replaced with the stack name e.g overcloud
  
    default: "%stackname%-computehci-%index%"
  
  ComputeHCIRemovalPolicies:
    default: []
    type: json
    description: >
      List of resources to be removed from ComputeHCI ResourceGroup when
      doing an update which requires removal of specific resources.
      Example format ComputeRemovalPolicies: [{'resource_list': ['0']}]

  ComputeHCIRemovalPoliciesMode:
    default: append
    type: string
    description: >
      How to handle change to RemovalPolicies for ComputeHCI
      ResourceGroup when doing an update. Default mode 'append' will
      append to the existing blacklist and 'update' would replace
      the blacklist.

  ComputeHCISchedulerHints:
    type: json
    description: Optional scheduler hints to pass to nova
    default: {}

  ComputeHCIParameters:
    type: json
    description: Optional Role Specific parameters to be provided to service
    default: {}

  ComputeHCIExtraGroupVars:
    type: json
    description: Optional extra Ansible group vars
    default: {}

  ComputeHCIControlPlaneSubnet:
    default: ctlplane-subnet
    description: |
      Name of the subnet on ctlplane network for this role.
    type: string

  ComputeHCIServiceNetMap:
    default: {}
    description: |
      Role specific ServiceNetMap overrides, the map provided will be merged
      with the global ServiceNetMap when passing the ServiceNetMap to the
      ComputeHCIServiceChain resource and the ComputeHCI resource group.
      For example:
      ComputeHCIServiceNetMap:
        NovaLibvirtNetwork: internal_api_leaf2
    type: json

  ComputeHCINetConfigOverride:
    default: {}
    description: |
      Custom JSON data to be used to override the os-net-config config.
      This is meant to be used by net_config_override parameter in tripleoclient
      to provide an easy means to pass in custom net configs for the Undercloud.
    type: json



  # Identifiers to trigger tasks on nodes
  UpdateIdentifier:
    default: ''
    type: string
    description: >
      Setting to a previously unused value during stack-update will trigger
      package update on all nodes
  DeployIdentifier:
    default: ''
    type: string
    description: >
      Setting this to a unique value will re-run any deployment tasks which
      perform configuration on a Heat stack-update.
  AddVipsToEtcHosts:
    default: True
    type: boolean
    description: >
      Set to true to append per network Vips to /etc/hosts on each node.

  DeploymentServerBlacklist:
    default: []
    type: comma_delimited_list
    description: >
      List of server hostnames to blacklist from any triggered deployments.

  GlobalConfigExtraMapData:
    type: json
    default: {}
    description: Map of extra global_config_settings data to set on each node.

  NetConfigDataLookup:
    type: json
    default: {}
    description: >
      Configure os-net-config mappings for specific nodes
      Your environment file needs to look like:
        parameter_defaults:
          NetConfigDataLookup:
            node1:
              nic1: "00:c8:7c:e6:f0:2e"
            node2:
              nic1: "00:18:7d:99:0c:b6"
            node3:
              dmiString: 'system-uuid'
              id: 'A8C85861-1B16-4803-8689-AFC62984F8F6'
              nic1: em3
            # Dell PowerEdge
            nodegroup1:
              dmiString: "system-product-name"
              id: "PowerEdge R630"
              nic1: em3
              nic2: em1
              nic3: em2
            # Cisco UCS B200-M4"
            nodegroup2:
              dmiString: "system-product-name"
              id: "UCSB-B200-M4"
              nic1: enp7s0
              nic2: enp6s0

      This will result in the first node* entry where either a mac matches a
      local device or a DMI String matches the specified id being written as a
      mapping file for os-net-config. (/etc/os-net-config/mapping.yaml)

  DnsServers: # Override this via parameter_defaults
    default: []
    description: >
      DNS servers to use for the Overcloud (2 max for some implementations).
      If not set the nameservers configured in the ctlplane subnet's
      dns_nameservers attribute will be used.
    type: comma_delimited_list

  RootStackName:
    description: The name of the stack/plan.
    type: string

  AdminPassword:
    description: The password for the keystone admin account, used for monitoring, querying neutron etc.
    type: string
    hidden: true

  KeystoneRegion:
    type: string
    default: 'regionOne'
    description: Keystone region for endpoint


parameter_groups:
- label: deprecated
  description: Do not use deprecated params, they will be removed.
  parameters:
    - DnsServers
    - controllerExtraConfig

conditions:
  add_vips_to_etc_hosts: {equals : [{get_param: AddVipsToEtcHosts}, True]}
  control_fixed_ip_not_set: {equals : [{get_param: ControlFixedIPs}, []]}
  internal_api_virtual_fixed_ip_set:
    not:
      equals:
        - get_param: InternalApiVirtualFixedIPs
        - []
  storage_virtual_fixed_ip_set:
    not:
      equals:
        - get_param: StorageVirtualFixedIPs
        - []
  storage_mgmt_virtual_fixed_ip_set:
    not:
      equals:
        - get_param: StorageMgmtVirtualFixedIPs
        - []
  tenant_virtual_fixed_ip_set:
    not:
      equals:
        - get_param: TenantVirtualFixedIPs
        - []
  public_virtual_fixed_ip_set:
    not:
      equals:
        - get_param: PublicVirtualFixedIPs
        - []
  set_default_mysql_cell_internal:
    or:
      - equals:
        - get_param: NovaAdditionalCell
        - true
      - and:
        - equals:
          - get_param: NovaAdditionalCell
          - false
        - equals:
          - get_param: [EndpointMapOverride, MysqlCellInternal]
          - ''
  set_default_nova_vnc_proxy_cell_public:
    or:
      - equals:
        - get_param: NovaAdditionalCell
        - true
      - and:
        - equals:
          - get_param: NovaAdditionalCell
          - false
        - equals:
          - get_param: [EndpointMapOverride, NovaVNCProxyCellPublic]
          - ''
  set_default_nova_metadata_cell_internal:
    or:
      - equals:
        - get_param: NovaLocalMetadataPerCell
        - true
      - and:
        - equals:
          - get_param: NovaLocalMetadataPerCell
          - false
        - equals:
          - get_param: [EndpointMapOverride, NovaMetadataCellInternal]
          - ''
  dnsservers_set:
    not:
      equals: [{get_param: DnsServers}, []]

resources:

  VipHosts:
    type: OS::Heat::Value
    properties:
      type: comma_delimited_list
      value:
        - str_replace:
            template: IP  HOST
            params:
              IP: {get_attr: [VipMap, net_ip_map, ctlplane]}
              HOST: {get_param: CloudNameCtlplane}
  # Special case the Internal API hostname param, which is CloudNameInternal
        - str_replace:
            template: IP  HOST
            params:
              IP: {get_attr: [VipMap, net_ip_map, internal_api]}
              HOST: {get_param: CloudNameInternal}
        - str_replace:
            template: IP  HOST
            params:
              IP: {get_attr: [VipMap, net_ip_map, storage]}
              HOST: {get_param: CloudNameStorage}
  # Special case StorageMgmt hostname param, which is CloudNameStorageManagement
        - str_replace:
            template: IP  HOST
            params:
              IP: {get_attr: [VipMap, net_ip_map, storage_mgmt]}
              HOST: {get_param: CloudNameStorageManagement}

  NetCidrMapValue:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_replace:
        - map_merge:
          - {get_attr: [Networks, net_cidr_map]}
          # NOTE(hjensas): When ctlplane network and subnets are created by the
          # undercloud installer, the subnet cidrs are added as tags.
          - ctlplane: {get_attr: [ControlVirtualIP, network, tags]}
        - keys:
            ctlplane: {get_param: NeutronControlPlaneID}

  NetIpVersionMapValue:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_replace:
        - map_merge:
          - {get_attr: [Networks, net_ip_version_map]}
          - ctlplane: {get_attr: [ControlVirtualIP, subnets, 0, ip_version]}
        - keys:
            ctlplane: {get_param: NeutronControlPlaneID}

  ServiceNetMap:
    type: OS::TripleO::ServiceNetMap

  EndpointMap:
    type: OS::TripleO::EndpointMap
    properties:
      CloudEndpoints:
        ctlplane: {get_param: CloudNameCtlplane}
  # Special case the Internal API hostname param, which is CloudNameInternal
        internal_api: {get_param: CloudNameInternal}
        storage: {get_param: CloudNameStorage}
  # Special case StorageMgmt hostname param, which is CloudNameStorageManagement
        storage_mgmt: {get_param: CloudNameStorageManagement}
      NetIpMap: {get_attr: [VipMap, net_ip_map]}
      ServiceNetMap: {get_attr: [ServiceNetMap, service_net_map]}

  EndpointMapData:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_merge:
          - {get_attr: [EndpointMap, endpoint_map]}
          - {get_param: EndpointMapOverride}
            # For parent stack we must set these to the local endpoints
            # For split-controlplane stacks that are nova cells we must set
            # these to the local endpoints
            # For split-controlplane stacks that are not nova cells we should
            # take these from EndpointMapOverride (i.e the parent stack)
          - if:
            - set_default_mysql_cell_internal
            - MysqlCellInternal: {get_attr: [EndpointMap, endpoint_map, MysqlInternal]}
            - {}
          - if:
            - set_default_nova_vnc_proxy_cell_public
            - NovaVNCProxyCellPublic: {get_attr: [EndpointMap, endpoint_map, NovaVNCProxyPublic]}
            - {}
          - if:
            - set_default_nova_metadata_cell_internal
            - NovaMetadataCellInternal: {get_attr: [EndpointMap, endpoint_map, NovaMetadataInternal]}
            - {}

  # Creates the "heat-admin" user if configured via the environment
  # Should return a OS::Heat::MultipartMime reference via OS::stack_id
  NodeAdminUserData:
    type: OS::TripleO::NodeAdminUserData

  # Bootstraps an ntp configuration and includes a hardware clock sync to
  # for containers.
  # Should return a OS::Heat::MultipartMime reference via OS::stack_id
  NodeTimesyncUserData:
    type: OS::TripleO::NodeTimesyncUserData

  # For optional operator additional userdata
  # Should return a OS::Heat::MultipartMime reference via OS::stack_id
  NodeUserData:
    type: OS::TripleO::NodeUserData

  # Jinja loop for Role in roles_data.yaml

  # Resources generated for Controller Role
  ControllerServiceChain:
    type: OS::TripleO::ControllerServices
    properties:
      Services:
        get_param: ControllerServices
      ServiceNetMap:
        map_merge:
          - {get_attr: [ServiceNetMap, service_net_map]}
          - {get_param: ControllerServiceNetMap}
      ServiceData:
        net_cidr_map: {get_attr: [NetCidrMapValue, value]}
        net_vip_map: {get_attr: [VipMap, net_ip_map]}
        net_ip_version_map: {get_attr: [NetIpVersionMapValue, value]}
        vip_subnet_map: {get_attr: [ServiceNetMap, vip_subnet_map]}
      EndpointMap: {get_attr: [EndpointMapData, value]}
      RoleName: Controller
      RoleParameters:
        map_merge:
          - {'OVNCMSOptions': 'enable-chassis-as-gw'}
          - get_param: ControllerParameters

  # Lookup of role_data via heat outputs is slow, so workaround this by caching
  # the value in an OS::Heat::Value resource
  ControllerServiceChainRoleData:
    type: OS::Heat::Value
    properties:
      type: json
      value: {get_attr: [ControllerServiceChain, role_data]}

  ControllerConfigData:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        service_configs: {get_attr: [ControllerServiceConfigSettings, value]}
        service_names: {get_attr: [ControllerServiceNames, value]}
        role_extraconfig:
          map_merge:
            - tripleo::profile::base::metrics::collectd::sensubility::subscriptions: {get_attr: [ControllerServiceChainRoleData, value, monitoring_subscriptions]}
            - tripleo_collectd_sensubility_subscriptions: {get_attr: [ControllerServiceChainRoleData, value, monitoring_subscriptions]}
            - {get_param: controllerExtraConfig}
            - {get_param: ControllerExtraConfig}
        extraconfig: {get_param: ExtraConfig}
        hieradata_files:
          - '%{::uuid}'
          - fqdn
          - docker_puppet # Optionally provided by container-puppet.sh
          - ansible_managed
          - heat_config_%{::deploy_config_name}
          - config_step
          - role_extraconfig
          - extraconfig
          - pci_passthrough_whitelist
          - service_names
          - service_configs
          - cloud_domain
          - bootstrap_node # provided by tripleo_hieradata
          - all_nodes # provided by tripleo_hieradata
          - vip_data # provided by tripleo_hieradata
          - net_ip_map
          - ovn_chassis_mac_map # provided by tripleo_hieradata
          - '%{::osfamily}'
          # The following are required for compatibility with the Controller role
          # where some vendor integrations added hieradata via ExtraConfigPre
          - neutron_bigswitch_data # Optionally provided by Controller/ComputeExtraConfigPre
          # Special variable for upgrade
          - upgrade

  ControllerServiceConfigSettings:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_merge:
          - get_param: GlobalConfigExtraMapData
          - get_attr: [ControllerServiceChainRoleData, value, config_settings]
          
          - get_attr: [ControllerServiceChainRoleData, value, global_config_settings]
          
          - get_attr: [ComputeHCIServiceChainRoleData, value, global_config_settings]
          
          # This next step combines two yaql passes:
          # - The inner one does a deep merge on the service_config_settings for all roles
          # - The outer one filters the map based on the services enabled for the role
          #   then merges the result into one map.
          - yaql:
              expression: let(root => $) -> $.data.map.items().where($[0] in coalesce($root.data.services, [])).select($[1]).reduce($1.mergeWith($2), {})
              data:
                map:
                  yaql:
                    expression: $.data.where($ != null).reduce($1.mergeWith($2), {})
                    data:
                    
                      - get_attr: [ControllerServiceChainRoleData, value, service_config_settings]
                    
                      - get_attr: [ComputeHCIServiceChainRoleData, value, service_config_settings]
                    
                services: {get_attr: [ControllerServiceNames, value]}

  # Filter any null/None service_names which may be present due to mapping
  # of services to OS::Heat::None
  ControllerServiceNames:
    type: OS::Heat::Value
    depends_on: ControllerServiceChain
    properties:
      type: comma_delimited_list
      value:
        yaql:
          expression: let(root => $) -> distinct($.data.extra_services.items().where($[0] in coalesce($root.data.enabled_services, [])).select($[1]).flatten() + coalesce($root.data.enabled_services, []))
          data:
            enabled_services: {get_attr: [ControllerServiceChainRoleData, value, service_names]}
            extra_services:
              # If anything other than keystone needs this
              # then we should add an extra_networks interface
              # to the service templates role_data but for
              # now we hard-code the keystone special case
              keystone:
                - keystone_admin_api
                - keystone_public_api

  ControllerIpListMap:
    type: OS::TripleO::Network::Ports::NetIpListMap
    properties:
      ControlPlaneIpList: {get_attr: [Controller, ip_address]}
      InternalApiIpList: {get_attr: [Controller, internal_api_ip_address]}
      StorageIpList: {get_attr: [Controller, storage_ip_address]}
      StorageMgmtIpList: {get_attr: [Controller, storage_mgmt_ip_address]}
      TenantIpList: {get_attr: [Controller, tenant_ip_address]}
      RoleNetworks:
        - ctlplane
        - internal_api
        - storage
        - storage_mgmt
        - tenant
      EnabledServices: {get_attr: [ControllerServiceNames, value]}
      ServiceNetMap: {get_attr: [ServiceNetMap, service_net_map_lower]}
      ServiceHostnameList: {get_attr: [Controller, hostname]}
      NetworkHostnameMap: {get_attr: [ControllerNetworkHostnameMap, value]}

  ControllerNetworkHostnameMap:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        # Note (shardy) this somewhat complex yaql may be replaced
        # with a map_deep_merge function in ocata.  It merges the
        # list of maps, but appends to colliding lists so we can
        # create a map of lists for all nodes for each network
        yaql:
          expression: dict($.data.where($ != null).flatten().selectMany($.items()).groupBy($[0], $[1]).select([$[0], $[1].flatten()]))
          data:
            - {get_attr: [Controller, hostname_map]}

  # Combine the NodeAdminUserData and NodeUserData mime archives
  ControllerUserData:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: {get_resource: NodeAdminUserData}
        type: multipart
      - config: {get_resource: NodeTimesyncUserData}
        type: multipart
      - config: {get_resource: NodeUserData}
        type: multipart
      - config: {get_resource: ControllerRoleUserData}
        type: multipart

  # For optional operator role-specific userdata
  # Should return a OS::Heat::MultipartMime reference via OS::stack_id
  ControllerRoleUserData:
    type: OS::TripleO::Controller::NodeUserData

  Controller:
    type: OS::Heat::ResourceGroup
    depends_on: Networks
    update_policy:
      batch_create:
        max_batch_size: {get_param: NodeCreateBatchSize}
    properties:
      count: {get_param: ControllerCount}
      removal_policies: {get_param: ControllerRemovalPolicies}
      removal_policies_mode: {get_param: ControllerRemovalPoliciesMode}
      resource_def:
        type: OS::TripleO::Controller
        properties:
          CloudDomain: {get_param: CloudDomain}
          ServiceNetMap:
            map_merge:
              - {get_attr: [ServiceNetMap, service_net_map]}
              - {get_param: ControllerServiceNetMap}
          EndpointMap: {get_attr: [EndpointMapData, value]}
          Hostname:
            str_replace:
              template: {get_param: ControllerHostnameFormat}
              params:
                '%stackname%': {get_param: 'OS::stack_name'}
          NodeIndex: '%index%'
          # Note, SchedulerHints must be defined here, not only in the
          # nested template, as it can contain %index%
          ControllerSchedulerHints:
            map_merge:
              - {get_param: ControllerSchedulerHints}
          ServiceNames: {get_attr: [ControllerServiceNames, value]}
          ServiceMetadataSettings: {get_attr: [ControllerServiceChainRoleData, value, service_metadata_settings]}
          OVNBridgeMappings: {get_attr: [ControllerServiceChainRoleData, value, config_settings, 'ovn::controller::ovn_bridge_mappings']}
          DeploymentServerBlacklistDict: {get_attr: [DeploymentServerBlacklistDict, value]}
          RoleParameters:
            map_merge:
              - {'OVNCMSOptions': 'enable-chassis-as-gw'}
              - get_param: ControllerParameters
          UserData: {get_resource: ControllerUserData}
  # Resources generated for ComputeHCI Role
  ComputeHCIServiceChain:
    type: OS::TripleO::ComputeHCIServices
    properties:
      Services:
        get_param: ComputeHCIServices
      ServiceNetMap:
        map_merge:
          - {get_attr: [ServiceNetMap, service_net_map]}
          - {get_param: ComputeHCIServiceNetMap}
      ServiceData:
        net_cidr_map: {get_attr: [NetCidrMapValue, value]}
        net_vip_map: {get_attr: [VipMap, net_ip_map]}
        net_ip_version_map: {get_attr: [NetIpVersionMapValue, value]}
        vip_subnet_map: {get_attr: [ServiceNetMap, vip_subnet_map]}
      EndpointMap: {get_attr: [EndpointMapData, value]}
      RoleName: ComputeHCI
      RoleParameters:
        map_merge:
          - {'FsAioMaxNumber': 1048576, 'TunedProfileName': 'throughput-performance', 'NovaComputeStartupDelay': 180}
          - get_param: ComputeHCIParameters

  # Lookup of role_data via heat outputs is slow, so workaround this by caching
  # the value in an OS::Heat::Value resource
  ComputeHCIServiceChainRoleData:
    type: OS::Heat::Value
    properties:
      type: json
      value: {get_attr: [ComputeHCIServiceChain, role_data]}

  ComputeHCIConfigData:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        service_configs: {get_attr: [ComputeHCIServiceConfigSettings, value]}
        service_names: {get_attr: [ComputeHCIServiceNames, value]}
        role_extraconfig:
          map_merge:
            - tripleo::profile::base::metrics::collectd::sensubility::subscriptions: {get_attr: [ComputeHCIServiceChainRoleData, value, monitoring_subscriptions]}
            - tripleo_collectd_sensubility_subscriptions: {get_attr: [ComputeHCIServiceChainRoleData, value, monitoring_subscriptions]}
            - {get_param: ComputeHCIExtraConfig}
        extraconfig: {get_param: ExtraConfig}
        hieradata_files:
          - '%{::uuid}'
          - fqdn
          - docker_puppet # Optionally provided by container-puppet.sh
          - ansible_managed
          - heat_config_%{::deploy_config_name}
          - config_step
          - role_extraconfig
          - extraconfig
          - pci_passthrough_whitelist
          - service_names
          - service_configs
          - cloud_domain
          - bootstrap_node # provided by tripleo_hieradata
          - all_nodes # provided by tripleo_hieradata
          - vip_data # provided by tripleo_hieradata
          - net_ip_map
          - ovn_chassis_mac_map # provided by tripleo_hieradata
          - '%{::osfamily}'
          # The following are required for compatibility with the Controller role
          # where some vendor integrations added hieradata via ExtraConfigPre
          - neutron_bigswitch_data # Optionally provided by Controller/ComputeExtraConfigPre
          # Special variable for upgrade
          - upgrade

  ComputeHCIServiceConfigSettings:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_merge:
          - get_param: GlobalConfigExtraMapData
          - get_attr: [ComputeHCIServiceChainRoleData, value, config_settings]
          
          - get_attr: [ControllerServiceChainRoleData, value, global_config_settings]
          
          - get_attr: [ComputeHCIServiceChainRoleData, value, global_config_settings]
          
          # This next step combines two yaql passes:
          # - The inner one does a deep merge on the service_config_settings for all roles
          # - The outer one filters the map based on the services enabled for the role
          #   then merges the result into one map.
          - yaql:
              expression: let(root => $) -> $.data.map.items().where($[0] in coalesce($root.data.services, [])).select($[1]).reduce($1.mergeWith($2), {})
              data:
                map:
                  yaql:
                    expression: $.data.where($ != null).reduce($1.mergeWith($2), {})
                    data:
                    
                      - get_attr: [ControllerServiceChainRoleData, value, service_config_settings]
                    
                      - get_attr: [ComputeHCIServiceChainRoleData, value, service_config_settings]
                    
                services: {get_attr: [ComputeHCIServiceNames, value]}

  # Filter any null/None service_names which may be present due to mapping
  # of services to OS::Heat::None
  ComputeHCIServiceNames:
    type: OS::Heat::Value
    depends_on: ComputeHCIServiceChain
    properties:
      type: comma_delimited_list
      value:
        yaql:
          expression: let(root => $) -> distinct($.data.extra_services.items().where($[0] in coalesce($root.data.enabled_services, [])).select($[1]).flatten() + coalesce($root.data.enabled_services, []))
          data:
            enabled_services: {get_attr: [ComputeHCIServiceChainRoleData, value, service_names]}
            extra_services:
              # If anything other than keystone needs this
              # then we should add an extra_networks interface
              # to the service templates role_data but for
              # now we hard-code the keystone special case
              keystone:
                - keystone_admin_api
                - keystone_public_api

  ComputeHCIIpListMap:
    type: OS::TripleO::Network::Ports::NetIpListMap
    properties:
      ControlPlaneIpList: {get_attr: [ComputeHCI, ip_address]}
      InternalApiIpList: {get_attr: [ComputeHCI, internal_api_ip_address]}
      StorageIpList: {get_attr: [ComputeHCI, storage_ip_address]}
      StorageMgmtIpList: {get_attr: [ComputeHCI, storage_mgmt_ip_address]}
      TenantIpList: {get_attr: [ComputeHCI, tenant_ip_address]}
      RoleNetworks:
        - ctlplane
        - internal_api
        - storage
        - storage_mgmt
        - tenant
      EnabledServices: {get_attr: [ComputeHCIServiceNames, value]}
      ServiceNetMap: {get_attr: [ServiceNetMap, service_net_map_lower]}
      ServiceHostnameList: {get_attr: [ComputeHCI, hostname]}
      NetworkHostnameMap: {get_attr: [ComputeHCINetworkHostnameMap, value]}

  ComputeHCINetworkHostnameMap:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        # Note (shardy) this somewhat complex yaql may be replaced
        # with a map_deep_merge function in ocata.  It merges the
        # list of maps, but appends to colliding lists so we can
        # create a map of lists for all nodes for each network
        yaql:
          expression: dict($.data.where($ != null).flatten().selectMany($.items()).groupBy($[0], $[1]).select([$[0], $[1].flatten()]))
          data:
            - {get_attr: [ComputeHCI, hostname_map]}

  # Combine the NodeAdminUserData and NodeUserData mime archives
  ComputeHCIUserData:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: {get_resource: NodeAdminUserData}
        type: multipart
      - config: {get_resource: NodeTimesyncUserData}
        type: multipart
      - config: {get_resource: NodeUserData}
        type: multipart
      - config: {get_resource: ComputeHCIRoleUserData}
        type: multipart

  # For optional operator role-specific userdata
  # Should return a OS::Heat::MultipartMime reference via OS::stack_id
  ComputeHCIRoleUserData:
    type: OS::TripleO::ComputeHCI::NodeUserData

  ComputeHCI:
    type: OS::Heat::ResourceGroup
    depends_on: Networks
    update_policy:
      batch_create:
        max_batch_size: {get_param: NodeCreateBatchSize}
    properties:
      count: {get_param: ComputeHCICount}
      removal_policies: {get_param: ComputeHCIRemovalPolicies}
      removal_policies_mode: {get_param: ComputeHCIRemovalPoliciesMode}
      resource_def:
        type: OS::TripleO::ComputeHCI
        properties:
          CloudDomain: {get_param: CloudDomain}
          ServiceNetMap:
            map_merge:
              - {get_attr: [ServiceNetMap, service_net_map]}
              - {get_param: ComputeHCIServiceNetMap}
          EndpointMap: {get_attr: [EndpointMapData, value]}
          Hostname:
            str_replace:
              template: {get_param: ComputeHCIHostnameFormat}
              params:
                '%stackname%': {get_param: 'OS::stack_name'}
          NodeIndex: '%index%'
          # Note, SchedulerHints must be defined here, not only in the
          # nested template, as it can contain %index%
          ComputeHCISchedulerHints:
            map_merge:
              - {get_param: ComputeHCISchedulerHints}
          ServiceNames: {get_attr: [ComputeHCIServiceNames, value]}
          ServiceMetadataSettings: {get_attr: [ComputeHCIServiceChainRoleData, value, service_metadata_settings]}
          OVNBridgeMappings: {get_attr: [ComputeHCIServiceChainRoleData, value, config_settings, 'ovn::controller::ovn_bridge_mappings']}
          DeploymentServerBlacklistDict: {get_attr: [DeploymentServerBlacklistDict, value]}
          RoleParameters:
            map_merge:
              - {'FsAioMaxNumber': 1048576, 'TunedProfileName': 'throughput-performance', 'NovaComputeStartupDelay': 180}
              - get_param: ComputeHCIParameters
          UserData: {get_resource: ComputeHCIUserData}
  ControllerServers:
    type: OS::Heat::Value
    depends_on: Controller
    properties:
      type: json
      value:
        yaql:
          expression: let(servers=>switch(isDict($.data.servers) => $.data.servers, true => {})) -> $servers.deleteAll($servers.keys().where($servers[$] = null))
          data:
            servers: {get_attr: [Controller, attributes, nova_server_resource]}
  ComputeHCIServers:
    type: OS::Heat::Value
    depends_on: ComputeHCI
    properties:
      type: json
      value:
        yaql:
          expression: let(servers=>switch(isDict($.data.servers) => $.data.servers, true => {})) -> $servers.deleteAll($servers.keys().where($servers[$] = null))
          data:
            servers: {get_attr: [ComputeHCI, attributes, nova_server_resource]}

  # This is a different format to *Servers, as it creates a map of lists
  # whereas *Servers creates a map of maps with keys of the nested resource names
  ServerIdMap:
    type: OS::Heat::Value
    properties:
      value:
        server_ids:
          Controller: {get_attr: [Controller, nova_server_resource]}
          ComputeHCI: {get_attr: [ComputeHCI, nova_server_resource]}
        bootstrap_server_id:
          yaql:
            expression: coalesce($.data, []).first(null)
            data: {get_attr: [Controller, nova_server_resource]}

  # This resource just creates a dict out of the DeploymentServerBlacklist,
  # which is a list. The dict is used in the role templates to set a condition
  # on whether to create the deployment resources. We can't use the list
  # directly because there is no way to ask Heat if a list contains a specific
  # value.
  DeploymentServerBlacklistDict:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_merge:
          repeat:
            template:
              hostname: 1
            for_each:
              hostname: {get_param: DeploymentServerBlacklist}

  HostsEntryValue:
    type: OS::Heat::Value
    properties:
      type: comma_delimited_list
      value:
        list_concat_unique:
          list_concat:
            - - {get_param: UndercloudHostsEntries}
            - - if:
                - add_vips_to_etc_hosts
                - {get_attr: [VipHosts, value]}
                - []
            - {get_attr: [Controller, hosts_entry]}
            - {get_attr: [ComputeHCI, hosts_entry]}
            - - {get_param: ExtraHostFileEntries}

  CloudNames:
    type: OS::Heat::Value
    properties:
      value:
        # Special case the Internal API hostname param, which is CloudNameInternal
        cloud_name_internal_api: {get_param: CloudNameInternal}
        cloud_name_storage: {get_param: CloudNameStorage}
        # Special case StorageMgmt hostname param, which is CloudNameStorageManagement
        cloud_name_storage_mgmt: {get_param: CloudNameStorageManagement}
        cloud_name_ctlplane: {get_param: CloudNameCtlplane}

  GlobalConfig:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        map_merge:

          - get_attr: [ControllerServiceChainRoleData, value, global_config_settings]

          - get_attr: [ComputeHCIServiceChainRoleData, value, global_config_settings]


  # creates the network architecture
  Networks:
    type: OS::TripleO::Network
    # Because of nested get_attr functions in *VirtualIP/VipMap,
    # we can't determine which attributes of Networks are used until after
    # ServiceNetMap's attribute values are available.
    depends_on: ServiceNetMap
    properties:
      CtlplaneNetworkCidrs: {get_attr: [ControlVirtualIP, network, tags]}

  # NOTE(tkajinam): Backend services and haproxy might be running in different
  #                 nodes, so we need to gather all frontend firewall rules
  #                 across all roles and pass the combined data to firewall
  #                 configuration task in the node where haproxy (or edge
  #                 haproxy) is assigned to.
  FirewallFrontendRules:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        frontend:
          map_merge:

            - get_attr: [ControllerServiceChainRoleData, value, firewall_frontend_rules]

            - get_attr: [ComputeHCIServiceChainRoleData, value, firewall_frontend_rules]

        ssl_frontend:
          map_merge:

            - get_attr: [ControllerServiceChainRoleData, value, firewall_ssl_frontend_rules]

            - get_attr: [ComputeHCIServiceChainRoleData, value, firewall_ssl_frontend_rules]

        edge_frontend:
          map_merge:

            - get_attr: [ControllerServiceChainRoleData, value, firewall_edge_frontend_rules]

            - get_attr: [ComputeHCIServiceChainRoleData, value, firewall_edge_frontend_rules]

        edge_ssl_frontend:
          map_merge:

            - get_attr: [ControllerServiceChainRoleData, value, firewall_edge_ssl_frontend_rules]

            - get_attr: [ComputeHCIServiceChainRoleData, value, firewall_edge_ssl_frontend_rules]

  ControllerGroupVars:
    type: OS::Heat::Value
    properties:
      value:
        ctlplane_mtu: {get_attr: [Networks, net_attributes_map, ctlplane, network, mtu]}
        ctlplane_gateway_ip: {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, gateway_ip]}
        ctlplane_dns_nameservers:
          if:
            - dnsservers_set
            - {get_param: DnsServers}
            - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, dns_nameservers]}
        ctlplane_subnet_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, cidr]}, 1]}
        ctlplane_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, host_routes]}
        # MTU is not filtered on role.networks, for DVR we need the External MTU on the exteranl_bridge
    
        internal_api_mtu: {get_attr: [Networks, net_attributes_map, internal_api, network, mtu]}
        storage_mtu: {get_attr: [Networks, net_attributes_map, storage, network, mtu]}
        storage_mgmt_mtu: {get_attr: [Networks, net_attributes_map, storage_mgmt, network, mtu]}
        tenant_mtu: {get_attr: [Networks, net_attributes_map, tenant, network, mtu]}
        internal_api_gateway_ip: {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, gateway_ip]}
        internal_api_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, host_routes]}
        internal_api_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, cidr]}, 1]}
        internal_api_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, tags]}
        storage_gateway_ip: {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, gateway_ip]}
        storage_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, host_routes]}
        storage_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, cidr]}, 1]}
        storage_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, tags]}
        storage_mgmt_gateway_ip: {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, gateway_ip]}
        storage_mgmt_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, host_routes]}
        storage_mgmt_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, cidr]}, 1]}
        storage_mgmt_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, tags]}
        tenant_gateway_ip: {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, gateway_ip]}
        tenant_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, host_routes]}
        tenant_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, cidr]}, 1]}
        tenant_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, tags]}
        network_cidrs:
          InternalApi_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, cidr]}, 1]}
          Storage_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, cidr]}, 1]}
          StorageMgmt_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, cidr]}, 1]}
          Tenant_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, cidr]}, 1]}
        dns_search_domains: {get_param: DnsSearchDomains}
        bond_interface_ovs_options: {get_param: BondInterfaceOvsOptions}
        local_mtu: {get_param: ControllerLocalMtu}
        role_networks:
          - InternalApi
          - Storage
          - StorageMgmt
          - Tenant
        networks_lower:
          InternalApi: internal_api
          Storage: storage
          StorageMgmt: storage_mgmt
          Tenant: tenant
        networks_all:
          - InternalApi
          - Storage
          - StorageMgmt
          - Tenant
        service_metadata_settings: {get_attr: [ControllerServiceChainRoleData, value, service_metadata_settings]}
        tripleo_network_config_template: {get_param: ControllerNetworkConfigTemplate}
        tripleo_network_config_with_ansible: {get_param: NetworkConfigWithAnsible}
        default_route_networks: ['External']
        networks_skip_config: []
        tripleo_firewall_rules: {get_attr: [ControllerServiceChainRoleData, value, firewall_rules]}
        tripleo_firewall_frontend_rules: {get_attr: [FirewallFrontendRules, value, frontend]}
        tripleo_firewall_ssl_frontend_rules: {get_attr: [FirewallFrontendRules, value, ssl_frontend]}
        tripleo_firewall_edge_frontend_rules: {get_attr: [FirewallFrontendRules, value, edge_frontend]}
        tripleo_firewall_edge_ssl_frontend_rules: {get_attr: [FirewallFrontendRules, value, edge_ssl_frontend]}
        role_tags: ['primary', 'controller', 'external_bridge']

  ControllerNetworkConfig:
    type: OS::TripleO::Controller::Net::SoftwareConfig
    properties:
      ControlPlaneIp: "{{ ctlplane_ip }}"
      ControlPlaneSubnetCidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, cidr]}, 1]}
      ControlPlaneDefaultRoute: {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, gateway_ip]}
      ControlPlaneStaticRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, host_routes]}
      ControlPlaneMtu: {get_attr: [Networks, net_attributes_map, ctlplane, network, mtu]}
      DnsServers:
        if:
          - dnsservers_set
          - {get_param: DnsServers}
          - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, dns_nameservers]}
      InternalApiIpSubnet: "{{ internal_api_ip ~ '/' ~ internal_api_cidr }}"
      InternalApiInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, host_routes]}
      InternalApiMtu: {get_attr: [Networks, net_attributes_map, internal_api, network, mtu]}
      InternalApiNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, tags]}
      StorageIpSubnet: "{{ storage_ip ~ '/' ~ storage_cidr }}"
      StorageInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, host_routes]}
      StorageMtu: {get_attr: [Networks, net_attributes_map, storage, network, mtu]}
      StorageNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, tags]}
      StorageMgmtIpSubnet: "{{ storage_mgmt_ip ~ '/' ~ storage_mgmt_cidr }}"
      StorageMgmtInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, host_routes]}
      StorageMgmtMtu: {get_attr: [Networks, net_attributes_map, storage_mgmt, network, mtu]}
      StorageMgmtNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, tags]}
      TenantIpSubnet: "{{ tenant_ip ~ '/' ~ tenant_cidr }}"
      TenantInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, host_routes]}
      TenantMtu: {get_attr: [Networks, net_attributes_map, tenant, network, mtu]}
      TenantNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, tags]}
  ComputeHCIGroupVars:
    type: OS::Heat::Value
    properties:
      value:
        ctlplane_mtu: {get_attr: [Networks, net_attributes_map, ctlplane, network, mtu]}
        ctlplane_gateway_ip: {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, gateway_ip]}
        ctlplane_dns_nameservers:
          if:
            - dnsservers_set
            - {get_param: DnsServers}
            - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, dns_nameservers]}
        ctlplane_subnet_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, cidr]}, 1]}
        ctlplane_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, host_routes]}
            - - default: true
                next_hop: {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, gateway_ip]}
        # MTU is not filtered on role.networks, for DVR we need the External MTU on the exteranl_bridge
    
        internal_api_mtu: {get_attr: [Networks, net_attributes_map, internal_api, network, mtu]}
        storage_mtu: {get_attr: [Networks, net_attributes_map, storage, network, mtu]}
        storage_mgmt_mtu: {get_attr: [Networks, net_attributes_map, storage_mgmt, network, mtu]}
        tenant_mtu: {get_attr: [Networks, net_attributes_map, tenant, network, mtu]}
        internal_api_gateway_ip: {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, gateway_ip]}
        internal_api_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, host_routes]}
        internal_api_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, cidr]}, 1]}
        internal_api_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, tags]}
        storage_gateway_ip: {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, gateway_ip]}
        storage_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, host_routes]}
        storage_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, cidr]}, 1]}
        storage_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, tags]}
        storage_mgmt_gateway_ip: {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, gateway_ip]}
        storage_mgmt_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, host_routes]}
        storage_mgmt_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, cidr]}, 1]}
        storage_mgmt_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, tags]}
        tenant_gateway_ip: {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, gateway_ip]}
        tenant_host_routes:
          list_concat_unique:
            - {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, host_routes]}
        tenant_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, cidr]}, 1]}
        tenant_vlan_id:
          yaql:
            expression: >
              switch(not isList($.data) => 1,
                     not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                     true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
            data: {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, tags]}
        network_cidrs:
          InternalApi_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, cidr]}, 1]}
          Storage_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, cidr]}, 1]}
          StorageMgmt_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, cidr]}, 1]}
          Tenant_cidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, cidr]}, 1]}
        dns_search_domains: {get_param: DnsSearchDomains}
        bond_interface_ovs_options: {get_param: BondInterfaceOvsOptions}
        local_mtu: {get_param: ComputeHCILocalMtu}
        role_networks:
          - InternalApi
          - Storage
          - StorageMgmt
          - Tenant
        networks_lower:
          InternalApi: internal_api
          Storage: storage
          StorageMgmt: storage_mgmt
          Tenant: tenant
        networks_all:
          - InternalApi
          - Storage
          - StorageMgmt
          - Tenant
        service_metadata_settings: {get_attr: [ComputeHCIServiceChainRoleData, value, service_metadata_settings]}
        tripleo_network_config_template: {get_param: ComputeHCINetworkConfigTemplate}
        tripleo_network_config_with_ansible: {get_param: NetworkConfigWithAnsible}
        default_route_networks: ['ControlPlane']
        networks_skip_config: []
        tripleo_firewall_rules: {get_attr: [ComputeHCIServiceChainRoleData, value, firewall_rules]}
        tripleo_firewall_frontend_rules: {get_attr: [FirewallFrontendRules, value, frontend]}
        tripleo_firewall_ssl_frontend_rules: {get_attr: [FirewallFrontendRules, value, ssl_frontend]}
        tripleo_firewall_edge_frontend_rules: {get_attr: [FirewallFrontendRules, value, edge_frontend]}
        tripleo_firewall_edge_ssl_frontend_rules: {get_attr: [FirewallFrontendRules, value, edge_ssl_frontend]}
        role_tags: ['compute']

  ComputeHCINetworkConfig:
    type: OS::TripleO::ComputeHCI::Net::SoftwareConfig
    properties:
      ControlPlaneIp: "{{ ctlplane_ip }}"
      ControlPlaneSubnetCidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, cidr]}, 1]}
      ControlPlaneDefaultRoute: {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, gateway_ip]}
      ControlPlaneStaticRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, host_routes]}
          - - default: true
              next_hop: {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, gateway_ip]}
      ControlPlaneMtu: {get_attr: [Networks, net_attributes_map, ctlplane, network, mtu]}
      DnsServers:
        if:
          - dnsservers_set
          - {get_param: DnsServers}
          - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, dns_nameservers]}
      InternalApiIpSubnet: "{{ internal_api_ip ~ '/' ~ internal_api_cidr }}"
      InternalApiInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, host_routes]}
      InternalApiMtu: {get_attr: [Networks, net_attributes_map, internal_api, network, mtu]}
      InternalApiNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, tags]}
      StorageIpSubnet: "{{ storage_ip ~ '/' ~ storage_cidr }}"
      StorageInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, host_routes]}
      StorageMtu: {get_attr: [Networks, net_attributes_map, storage, network, mtu]}
      StorageNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, tags]}
      StorageMgmtIpSubnet: "{{ storage_mgmt_ip ~ '/' ~ storage_mgmt_cidr }}"
      StorageMgmtInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, host_routes]}
      StorageMgmtMtu: {get_attr: [Networks, net_attributes_map, storage_mgmt, network, mtu]}
      StorageMgmtNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, tags]}
      TenantIpSubnet: "{{ tenant_ip ~ '/' ~ tenant_cidr }}"
      TenantInterfaceRoutes:
        list_concat_unique:
          - {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, host_routes]}
      TenantMtu: {get_attr: [Networks, net_attributes_map, tenant, network, mtu]}
      TenantNetworkVlanID:
        yaql:
          expression: >
            switch(not isList($.data) => 1,
                   not $.data.where($.startsWith('tripleo_vlan_id')).len() => 1,
                   true => int($.data.where($.startsWith('tripleo_vlan_id')).first().split('=').last()))
          data: {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, tags]}

  ControlVirtualIP:
    depends_on: ServiceNetMap
    type: OS::TripleO::Network::Ports::ControlPlaneVipPort
    properties:
      name: control_virtual_ip
      dns_name: {str_split: ['.', {get_param: CloudNameCtlplane}, 0]}
      network: {get_param: NeutronControlPlaneID}
      fixed_ips:
        if:
        - control_fixed_ip_not_set
        - [{subnet: {get_attr: [ServiceNetMap, vip_subnet_map, ctlplane]}}]
        - get_param: ControlFixedIPs
      replacement_policy: AUTO
      tags:
        - tripleo_vip_net=ctlplane
        - str_replace:
            template: tripleo_stack_name=$STACK_NAME
            params:
              $STACK_NAME: {get_param: 'OS::stack_name'}
  InternalApiVirtualIP:
    depends_on: [Networks, ServiceNetMap]
    type: OS::TripleO::Network::Ports::InternalApiVipPort
    properties:
      ControlPlaneIP: {get_attr: [ControlVirtualIP, fixed_ips, 0, ip_address]}
      ControlPlaneSubnetCidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_attr: [ServiceNetMap, vip_subnet_map, ctlplane]}, cidr]}, 1]}
      PortName: internal_api_virtual_ip
      DnsName: {str_split: ['.', {get_param: CloudNameInternal}, 0]}
      FixedIPs:
        if:
        - internal_api_virtual_fixed_ip_set
        - {get_param: InternalApiVirtualFixedIPs}
        - [{subnet: {get_attr: [ServiceNetMap, vip_subnet_map, InternalApi]}}]
      IsVirtualIP: true
  StorageVirtualIP:
    depends_on: [Networks, ServiceNetMap]
    type: OS::TripleO::Network::Ports::StorageVipPort
    properties:
      ControlPlaneIP: {get_attr: [ControlVirtualIP, fixed_ips, 0, ip_address]}
      ControlPlaneSubnetCidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_attr: [ServiceNetMap, vip_subnet_map, ctlplane]}, cidr]}, 1]}
      PortName: storage_virtual_ip
      DnsName: {str_split: ['.', {get_param: CloudNameStorage}, 0]}
      FixedIPs:
        if:
        - storage_virtual_fixed_ip_set
        - {get_param: StorageVirtualFixedIPs}
        - [{subnet: {get_attr: [ServiceNetMap, vip_subnet_map, Storage]}}]
      IsVirtualIP: true
  StorageMgmtVirtualIP:
    depends_on: [Networks, ServiceNetMap]
    type: OS::TripleO::Network::Ports::StorageMgmtVipPort
    properties:
      ControlPlaneIP: {get_attr: [ControlVirtualIP, fixed_ips, 0, ip_address]}
      ControlPlaneSubnetCidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_attr: [ServiceNetMap, vip_subnet_map, ctlplane]}, cidr]}, 1]}
      PortName: storage_mgmt_virtual_ip
      DnsName: {str_split: ['.', {get_param: CloudNameStorageManagement}, 0]}
      FixedIPs:
        if:
        - storage_mgmt_virtual_fixed_ip_set
        - {get_param: StorageMgmtVirtualFixedIPs}
        - [{subnet: {get_attr: [ServiceNetMap, vip_subnet_map, StorageMgmt]}}]
      IsVirtualIP: true

  VipMap:
    type: OS::TripleO::Network::Ports::NetVipMap
    properties:
      ControlPlaneIp: {get_attr: [ControlVirtualIP, fixed_ips, 0, ip_address]}
      ControlPlaneSubnetCidr: {str_split: ['/', {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_attr: [ServiceNetMap, vip_subnet_map, ctlplane]}, cidr]}, 1]}
      InternalApiIp: {get_attr: [InternalApiVirtualIP, ip_address]}
      InternalApiIpUri: {get_attr: [InternalApiVirtualIP, ip_address_uri]}
      StorageIp: {get_attr: [StorageVirtualIP, ip_address]}
      StorageIpUri: {get_attr: [StorageVirtualIP, ip_address_uri]}
      StorageMgmtIp: {get_attr: [StorageMgmtVirtualIP, ip_address]}
      StorageMgmtIpUri: {get_attr: [StorageMgmtVirtualIP, ip_address_uri]}
      # No tenant or management VIP required
    # Because of nested get_attr functions in the KeystoneAdminVip output, we
    # can't determine which attributes of VipMap are used until after
    # ServiceNetMap's attribute values are available.
    depends_on: ServiceNetMap

  # Optional ExtraConfig for all nodes - all roles are passed in here, but
  # the nested template may configure each role differently (or not at all)
  AllNodesExtraConfig:
    type: OS::TripleO::AllNodesExtraConfig
    properties:
      servers:
        Controller: {get_attr: [ControllerServers, value]}
        ComputeHCI: {get_attr: [ComputeHCIServers, value]}

  BlacklistedIpAddresses:
    type: OS::Heat::Value
    properties:
      value:
        list_concat:
          - {get_attr: [Controller, blacklist_ip_address]}
          - {get_attr: [ComputeHCI, blacklist_ip_address]}

  AnsibleHostVars:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        Controller:
          map_merge:
            list_concat:
            - {get_attr: [Controller, ansible_host_vars_map]}
        ComputeHCI:
          map_merge:
            list_concat:
            - {get_attr: [ComputeHCI, ansible_host_vars_map]}

  BlacklistedHostnames:
    type: OS::Heat::Value
    properties:
      value:
        list_concat:
          - {get_attr: [Controller, blacklist_hostname]}
          - {get_attr: [ComputeHCI, blacklist_hostname]}

  # Post deployment steps for all roles
  AllNodesDeploySteps:
    type: OS::TripleO::PostDeploySteps
    depends_on:
      - AllNodesExtraConfig
    properties:
      servers:
        Controller: {get_attr: [ControllerServers, value]}
        ComputeHCI: {get_attr: [ComputeHCIServers, value]}
      EndpointMap: {get_attr: [EndpointMapData, value]}
      role_data:
        Controller: {get_attr: [ControllerServiceChainRoleData, value]}
        ComputeHCI: {get_attr: [ComputeHCIServiceChainRoleData, value]}
      ControllerCount: {get_param: ControllerCount}
      ComputeHCICount: {get_param: ComputeHCICount}
      ServiceNetMapLower: {get_attr: [ServiceNetMap, service_net_map_lower]}
      PingTestGatewayIPsMap:
        Controller:
          yaql:
            expression: list($.data.where($ != null and len($) > 0)).flatten()
            data:
              - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ControllerControlPlaneSubnet}, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, gateway_ip]}
        ComputeHCI:
          yaql:
            expression: list($.data.where($ != null and len($) > 0)).flatten()
            data:
              - {get_attr: [Networks, net_attributes_map, ctlplane, subnets, {get_param: ComputeHCIControlPlaneSubnet}, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, internal_api, subnets, internal_api_subnet, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, storage, subnets, storage_subnet, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, storage_mgmt, subnets, storage_mgmt_subnet, gateway_ip]}
              - {get_attr: [Networks, net_attributes_map, tenant, subnets, tenant_subnet, gateway_ip]}
      PingTestIpsMap:
        Controller:
          list_join:
          - ' '
          - - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [Controller, ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [Controller, internal_api_ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [Controller, storage_ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [Controller, storage_mgmt_ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [Controller, tenant_ip_address]}
        ComputeHCI:
          list_join:
          - ' '
          - - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [ComputeHCI, ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [ComputeHCI, internal_api_ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [ComputeHCI, storage_ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [ComputeHCI, storage_mgmt_ip_address]}
            - yaql:
                expression: coalesce($.data, []).first(null)
                data: {get_attr: [ComputeHCI, tenant_ip_address]}
      HostsEntry: {get_attr: [HostsEntryValue, value]}
      EnabledServices:
        list_concat:
          - {get_attr: [ControllerServiceNames, value]}
          - {get_attr: [ComputeHCIServiceNames, value]}
      ControlVirtualIP: {get_attr: [ControlVirtualIP, fixed_ips, 0, ip_address]}
      EnabledNetworks:
        - InternalApi
        - Storage
        - StorageMgmt
        - Tenant
      NetVipMap: {get_attr: [VipMap, net_ip_map]}
      CloudNames: {get_attr: [CloudNames, value]}
      UndercloudHostsEntries: {get_param: UndercloudHostsEntries}
      ExtraHostsEntries: {get_param: ExtraHostFileEntries}
      VipHostsEntries:
        if:
          - add_vips_to_etc_hosts
          - {get_attr: [VipHosts, value]}
          - []
      KeystoneResourcesConfigs:
        map_merge:

          - get_attr: [ControllerServiceChainRoleData, value, keystone_resources]

          - get_attr: [ComputeHCIServiceChainRoleData, value, keystone_resources]

      NetCidrMap: {get_attr: [NetCidrMapValue, value]}

outputs:
  ManagedEndpoints:
    description: Asserts that the keystone endpoints have been provisioned.
    value: true
  KeystoneURL:
    description: URL for the Overcloud Keystone service
    value: {get_attr: [EndpointMapData, value, KeystonePublic, uri_no_suffix]}
  KeystoneAdminVip:
    description: Keystone Admin VIP endpoint
    # Note that these nested get_attr functions require a dependency
    # relationship between VipMap and ServiceNetMap, since we can't determine
    # which attributes of VipMap are used until after ServiceNetMap's attribute
    # values are available. If this is ever reworked to not use nested
    # get_attr, that dependency can be removed.
    value: {get_attr: [VipMap, net_ip_map, {get_attr: [ServiceNetMap, service_net_map, KeystoneAdminApiNetwork]}]}
  EndpointMap:
    description: |
      Mapping of the resources with the needed info for their endpoints.
      This includes the protocol used, the IP, port and also a full
      representation of the URI.
    value: {get_attr: [EndpointMapData, value]}
  HostsEntry:
    description: |
      The content that should be appended to your /etc/hosts if you want to get
      hostname-based access to the deployed nodes (useful for testing without
      setting up a DNS).
    value:
      list_concat_unique:
        - {get_attr: [HostsEntryValue, value]}
        - {get_attr: [VipHosts, value]}
  EnabledServices:
    description: The services enabled on each role
    value:
      Controller: {get_attr: [ControllerServiceNames, value]}
      ComputeHCI: {get_attr: [ComputeHCIServiceNames, value]}
  RoleData:
    description: The configuration data associated with each role
    value:
      Controller: {get_attr: [ControllerServiceChainRoleData, value]}
      ComputeHCI: {get_attr: [ComputeHCIServiceChainRoleData, value]}
  RoleConfig:
    description: The configuration workflows associated with each role
    value: {get_attr: [AllNodesDeploySteps, RoleConfig]}
  RoleNetIpMap:
    description: Mapping of each network to a list of IPs for each role
    value:
      Controller: {get_attr: [ControllerIpListMap, net_ip_map]}
      ComputeHCI: {get_attr: [ComputeHCIIpListMap, net_ip_map]}
  RoleGroupVars:
    description: Mapping of roles to ansible group_vars to be applied config in those roles
    value:
      Controller:
        map_merge:
        - {get_attr: [ControllerGroupVars, value]}
        - {get_attr: [ControllerConfigData, value]}
        - any_errors_fatal: {get_param: ControllerAnyErrorsFatal}
          max_fail_percentage: {get_param: ControllerMaxFailPercentage}
          neutron_physical_bridge_name: {get_param: NeutronPhysicalBridge}
          neutron_public_interface_name: {get_param: NeutronPublicInterface}
          network_config_update: {get_param: ControllerNetworkConfigUpdate}
          tripleo_network_config_os_net_config_mappings: {get_param: NetConfigDataLookup}
          deployed_server_port_map: {get_param: DeployedServerPortMap}
          tripleo_network_config_override: {get_param: ControllerNetConfigOverride}
          tripleo_stack_name: {get_param: RootStackName}
        - {get_param: ControllerExtraGroupVars}
      ComputeHCI:
        map_merge:
        - {get_attr: [ComputeHCIGroupVars, value]}
        - {get_attr: [ComputeHCIConfigData, value]}
        - any_errors_fatal: {get_param: ComputeHCIAnyErrorsFatal}
          max_fail_percentage: {get_param: ComputeHCIMaxFailPercentage}
          neutron_physical_bridge_name: {get_param: NeutronPhysicalBridge}
          neutron_public_interface_name: {get_param: NeutronPublicInterface}
          network_config_update: {get_param: ComputeHCINetworkConfigUpdate}
          tripleo_network_config_os_net_config_mappings: {get_param: NetConfigDataLookup}
          deployed_server_port_map: {get_param: DeployedServerPortMap}
          tripleo_network_config_override: {get_param: ComputeHCINetConfigOverride}
          tripleo_stack_name: {get_param: RootStackName}
        - {get_param: ComputeHCIExtraGroupVars}
  RoleNetHostnameMap:
    description: Mapping of each network to a list of hostnames for each role
    value:
      Controller: {get_attr: [ControllerNetworkHostnameMap, value]}
      ComputeHCI: {get_attr: [ComputeHCINetworkHostnameMap, value]}
  RoleTags:
    description: Tags for each role, as defined in roles_data.yaml
    value:
      Controller: ['primary', 'controller', 'external_bridge']
      ComputeHCI: ['compute']
  VipMap:
    description: Mapping of each network to VIP addresses. Also includes the Redis and OVN DBs VIPs.
    value: {get_attr: [VipMap, net_ip_map]}
  ServerIdData:
    description: Mapping of each role to a list of nova server IDs and the bootstrap ID
    value: {get_attr: [ServerIdMap, value]}
  BlacklistedHostnames:
    description: List of blacklisted hostnames
    value: {get_attr: [BlacklistedHostnames, value]}
  BlacklistedIpAddresses:
    description: List of blacklisted ctlplane IP addresses
    value: {get_attr: [BlacklistedIpAddresses, value]}
  GlobalConfig:
    description: The global_config (hieradata).
    value: {get_attr: [GlobalConfig, value]}
  RoleNetworkConfigMap:
    description: Mapping of roles to network config
    value:
      Controller: {get_attr: [ControllerNetworkConfig, config]}
      ComputeHCI: {get_attr: [ComputeHCINetworkConfig, config]}
  AnsibleHostVarsMap:
    description: Map of Ansible Host variables per role
    value: {get_attr: [AnsibleHostVars, value]}
  TripleoHeatTemplatesJinja2RenderingDataSources:
    description: The role_data and the network_data used when rendering the THT Jinja2 templates
    value:
      roles_data: [{'name': 'Controller', 'description': 'Controller role that has all the controler services loaded and handles\nDatabase, Messaging and Network functions.\n', 'CountDefault': 1, 'tags': ['primary', 'controller', 'external_bridge'], 'networks': {'External': {'subnet': 'external_subnet'}, 'InternalApi': {'subnet': 'internal_api_subnet'}, 'Storage': {'subnet': 'storage_subnet'}, 'StorageMgmt': {'subnet': 'storage_mgmt_subnet'}, 'Tenant': {'subnet': 'tenant_subnet'}}, 'default_route_networks': ['External'], 'HostnameFormatDefault': '%stackname%-controller-%index%', 'RoleParametersDefault': {'OVNCMSOptions': 'enable-chassis-as-gw'}, 'uses_deprecated_params': True, 'deprecated_param_extraconfig': 'controllerExtraConfig', 'deprecated_param_flavor': 'OvercloudControlFlavor', 'deprecated_param_image': 'controllerImage', 'deprecated_nic_config_name': 'controller.yaml', 'update_serial': 1, 'ServicesDefault': ['OS::TripleO::Services::Aide', 'OS::TripleO::Services::AodhApi', 'OS::TripleO::Services::AodhEvaluator', 'OS::TripleO::Services::AodhListener', 'OS::TripleO::Services::AodhNotifier', 'OS::TripleO::Services::AuditD', 'OS::TripleO::Services::BarbicanApi', 'OS::TripleO::Services::BarbicanBackendSimpleCrypto', 'OS::TripleO::Services::BarbicanBackendDogtag', 'OS::TripleO::Services::BarbicanBackendKmip', 'OS::TripleO::Services::BarbicanBackendPkcs11Crypto', 'OS::TripleO::Services::BootParams', 'OS::TripleO::Services::CACerts', 'OS::TripleO::Services::CeilometerAgentCentral', 'OS::TripleO::Services::CeilometerAgentNotification', 'OS::TripleO::Services::CephClient', 'OS::TripleO::Services::CephExternal', 'OS::TripleO::Services::CephGrafana', 'OS::TripleO::Services::CephMds', 'OS::TripleO::Services::CephMgr', 'OS::TripleO::Services::CephMon', 'OS::TripleO::Services::CephNfs', 'OS::TripleO::Services::CephRbdMirror', 'OS::TripleO::Services::CephRgw', 'OS::TripleO::Services::CinderApi', 'OS::TripleO::Services::CinderBackendDellSc', 'OS::TripleO::Services::CinderBackendDellEMCPowerFlex', 'OS::TripleO::Services::CinderBackendDellEMCPowermax', 'OS::TripleO::Services::CinderBackendDellEMCPowerStore', 'OS::TripleO::Services::CinderBackendDellEMCSc', 'OS::TripleO::Services::CinderBackendDellEMCUnity', 'OS::TripleO::Services::CinderBackendDellEMCVMAXISCSI', 'OS::TripleO::Services::CinderBackendDellEMCVNX', 'OS::TripleO::Services::CinderBackendDellEMCVxFlexOS', 'OS::TripleO::Services::CinderBackendDellEMCXtremio', 'OS::TripleO::Services::CinderBackendNetApp', 'OS::TripleO::Services::CinderBackendPure', 'OS::TripleO::Services::CinderBackendScaleIO', 'OS::TripleO::Services::CinderBackendNVMeOF', 'OS::TripleO::Services::CinderBackup', 'OS::TripleO::Services::CinderHPELeftHandISCSI', 'OS::TripleO::Services::CinderScheduler', 'OS::TripleO::Services::CinderVolume', 'OS::TripleO::Services::Clustercheck', 'OS::TripleO::Services::Collectd', 'OS::TripleO::Services::ContainerImagePrepare', 'OS::TripleO::Services::DesignateApi', 'OS::TripleO::Services::DesignateCentral', 'OS::TripleO::Services::DesignateProducer', 'OS::TripleO::Services::DesignateWorker', 'OS::TripleO::Services::DesignateMDNS', 'OS::TripleO::Services::DesignateSink', 'OS::TripleO::Services::DesignateBind', 'OS::TripleO::Services::Etcd', 'OS::TripleO::Services::ExternalSwiftProxy', 'OS::TripleO::Services::Frr', 'OS::TripleO::Services::GlanceApi', 'OS::TripleO::Services::GlanceApiInternal', 'OS::TripleO::Services::GnocchiApi', 'OS::TripleO::Services::GnocchiMetricd', 'OS::TripleO::Services::GnocchiStatsd', 'OS::TripleO::Services::HAproxy', 'OS::TripleO::Services::HeatApi', 'OS::TripleO::Services::HeatApiCloudwatch', 'OS::TripleO::Services::HeatApiCfn', 'OS::TripleO::Services::HeatEngine', 'OS::TripleO::Services::Horizon', 'OS::TripleO::Services::IpaClient', 'OS::TripleO::Services::Ipsec', 'OS::TripleO::Services::IronicApi', 'OS::TripleO::Services::IronicConductor', 'OS::TripleO::Services::IronicInspector', 'OS::TripleO::Services::IronicPxe', 'OS::TripleO::Services::IronicNeutronAgent', 'OS::TripleO::Services::Iscsid', 'OS::TripleO::Services::Kernel', 'OS::TripleO::Services::Keystone', 'OS::TripleO::Services::LoginDefs', 'OS::TripleO::Services::ManilaApi', 'OS::TripleO::Services::ManilaBackendCephFs', 'OS::TripleO::Services::ManilaBackendIsilon', 'OS::TripleO::Services::ManilaBackendNetapp', 'OS::TripleO::Services::ManilaBackendPowerMax', 'OS::TripleO::Services::ManilaBackendUnity', 'OS::TripleO::Services::ManilaBackendVNX', 'OS::TripleO::Services::ManilaBackendVMAX', 'OS::TripleO::Services::ManilaScheduler', 'OS::TripleO::Services::ManilaShare', 'OS::TripleO::Services::Memcached', 'OS::TripleO::Services::MetricsQdr', 'OS::TripleO::Services::Multipathd', 'OS::TripleO::Services::MySQL', 'OS::TripleO::Services::MySQLClient', 'OS::TripleO::Services::NeutronApi', 'OS::TripleO::Services::NeutronBgpVpnApi', 'OS::TripleO::Services::NeutronSfcApi', 'OS::TripleO::Services::NeutronCorePlugin', 'OS::TripleO::Services::NeutronDhcpAgent', 'OS::TripleO::Services::NeutronL2gwAgent', 'OS::TripleO::Services::NeutronL2gwApi', 'OS::TripleO::Services::NeutronL3Agent', 'OS::TripleO::Services::NeutronLinuxbridgeAgent', 'OS::TripleO::Services::NeutronMetadataAgent', 'OS::TripleO::Services::NeutronOvsAgent', 'OS::TripleO::Services::NeutronVppAgent', 'OS::TripleO::Services::NeutronAgentsIBConfig', 'OS::TripleO::Services::NovaApi', 'OS::TripleO::Services::NovaConductor', 'OS::TripleO::Services::NovaIronic', 'OS::TripleO::Services::NovaMetadata', 'OS::TripleO::Services::NovaScheduler', 'OS::TripleO::Services::NovaVncProxy', 'OS::TripleO::Services::ContainersLogrotateCrond', 'OS::TripleO::Services::OctaviaApi', 'OS::TripleO::Services::OctaviaDeploymentConfig', 'OS::TripleO::Services::OctaviaHealthManager', 'OS::TripleO::Services::OctaviaHousekeeping', 'OS::TripleO::Services::OctaviaWorker', 'OS::TripleO::Services::OpenStackClients', 'OS::TripleO::Services::OVNDBs', 'OS::TripleO::Services::OVNController', 'OS::TripleO::Services::Pacemaker', 'OS::TripleO::Services::PlacementApi', 'OS::TripleO::Services::OsloMessagingRpc', 'OS::TripleO::Services::OsloMessagingNotify', 'OS::TripleO::Services::Podman', 'OS::TripleO::Services::Redis', 'OS::TripleO::Services::Rhsm', 'OS::TripleO::Services::Rsyslog', 'OS::TripleO::Services::RsyslogSidecar', 'OS::TripleO::Services::Securetty', 'OS::TripleO::Services::Snmp', 'OS::TripleO::Services::Sshd', 'OS::TripleO::Services::SwiftProxy', 'OS::TripleO::Services::SwiftDispersion', 'OS::TripleO::Services::SwiftRingBuilder', 'OS::TripleO::Services::SwiftStorage', 'OS::TripleO::Services::Timesync', 'OS::TripleO::Services::Timezone', 'OS::TripleO::Services::TripleoFirewall', 'OS::TripleO::Services::TripleoPackages', 'OS::TripleO::Services::Tuned', 'OS::TripleO::Services::Unbound', 'OS::TripleO::Services::Vpp']}, {'name': 'ComputeHCI', 'description': 'Compute Node role hosting Ceph OSD too\n', 'tags': ['compute'], 'networks': {'InternalApi': {'subnet': 'internal_api_subnet'}, 'Tenant': {'subnet': 'tenant_subnet'}, 'Storage': {'subnet': 'storage_subnet'}, 'StorageMgmt': {'subnet': 'storage_mgmt_subnet'}}, 'RoleParametersDefault': {'FsAioMaxNumber': 1048576, 'TunedProfileName': 'throughput-performance', 'NovaComputeStartupDelay': 180}, 'update_serial': 1, 'ServicesDefault': ['OS::TripleO::Services::Aide', 'OS::TripleO::Services::AuditD', 'OS::TripleO::Services::BootParams', 'OS::TripleO::Services::CACerts', 'OS::TripleO::Services::CephClient', 'OS::TripleO::Services::CephExternal', 'OS::TripleO::Services::CephOSD', 'OS::TripleO::Services::Collectd', 'OS::TripleO::Services::ComputeCeilometerAgent', 'OS::TripleO::Services::CeilometerAgentIpmi', 'OS::TripleO::Services::ComputeNeutronCorePlugin', 'OS::TripleO::Services::ComputeNeutronL3Agent', 'OS::TripleO::Services::ComputeNeutronMetadataAgent', 'OS::TripleO::Services::ComputeNeutronOvsAgent', 'OS::TripleO::Services::Frr', 'OS::TripleO::Services::IpaClient', 'OS::TripleO::Services::Ipsec', 'OS::TripleO::Services::Iscsid', 'OS::TripleO::Services::Kernel', 'OS::TripleO::Services::LoginDefs', 'OS::TripleO::Services::MetricsQdr', 'OS::TripleO::Services::Multipathd', 'OS::TripleO::Services::MySQLClient', 'OS::TripleO::Services::NeutronBgpVpnBagpipe', 'OS::TripleO::Services::NeutronLinuxbridgeAgent', 'OS::TripleO::Services::NeutronVppAgent', 'OS::TripleO::Services::NovaAZConfig', 'OS::TripleO::Services::NovaCompute', 'OS::TripleO::Services::NovaLibvirt', 'OS::TripleO::Services::NovaLibvirtGuests', 'OS::TripleO::Services::NovaMigrationTarget', 'OS::TripleO::Services::ContainersLogrotateCrond', 'OS::TripleO::Services::Podman', 'OS::TripleO::Services::Rhsm', 'OS::TripleO::Services::Rsyslog', 'OS::TripleO::Services::RsyslogSidecar', 'OS::TripleO::Services::Securetty', 'OS::TripleO::Services::Snmp', 'OS::TripleO::Services::Sshd', 'OS::TripleO::Services::Timesync', 'OS::TripleO::Services::Timezone', 'OS::TripleO::Services::TripleoFirewall', 'OS::TripleO::Services::TripleoPackages', 'OS::TripleO::Services::Tuned', 'OS::TripleO::Services::Vpp', 'OS::TripleO::Services::OVNController', 'OS::TripleO::Services::OVNMetadataAgent']}]
      networks_data: [{'name': 'InternalApi', 'name_lower': 'internal_api', 'vip': True, 'mtu': 1400, 'ipv6': False, 'subnets': {'internal_api_subnet': {'vlan': 3802, 'ip_subnet': '172.16.2.0/24', 'allocation_pools': [{'start': '172.16.2.10', 'end': '172.16.2.50'}]}}, 'idx': 0}, {'name': 'Storage', 'name_lower': 'storage', 'vip': True, 'mtu': 1400, 'ipv6': False, 'subnets': {'storage_subnet': {'vlan': 3804, 'ip_subnet': '172.16.4.0/24', 'allocation_pools': [{'start': '172.16.4.10', 'end': '172.16.4.50'}]}}, 'idx': 1}, {'name': 'StorageMgmt', 'name_lower': 'storage_mgmt', 'vip': True, 'mtu': 1400, 'ipv6': False, 'subnets': {'storage_mgmt_subnet': {'vlan': 3805, 'ip_subnet': '172.16.5.0/24', 'allocation_pools': [{'start': '172.16.5.10', 'end': '172.16.5.50'}]}}, 'idx': 2}, {'name': 'Tenant', 'name_lower': 'tenant', 'vip': False, 'mtu': 1400, 'ipv6': False, 'subnets': {'tenant_subnet': {'vlan': 3803, 'ip_subnet': '172.16.3.0/24', 'allocation_pools': [{'start': '172.16.3.10', 'end': '172.16.3.50'}]}}, 'idx': 3}]
  AdminPassword:
    description: The password for the keystone admin account, used for monitoring, querying neutron etc.
    value: {get_param: AdminPassword}
  KeystoneRegion:
    description: Keystone region for endpoint
    value: {get_param: KeystoneRegion}